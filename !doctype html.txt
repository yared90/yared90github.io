<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brand Employment Agent — Demo</title>
  <style>
    :root{--bg:#0f1724;--muted:#9aa4b2;--card:#071227;--accent:#6ee7b7}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#071428 0%, #081226 100%);color:#e6eef6;min-height:100vh}
    header{padding:18px 24px;display:flex;justify-content:space-between;align-items:center}
    a.logo{font-weight:700;color:var(--accent);text-decoration:none}
    nav a{margin-left:12px;color:var(--muted);text-decoration:none}
    .wrap{max-width:1100px;margin:18px auto;padding:0 18px}
    .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1,h2{margin:0 0 8px}
    p.lead{color:var(--muted)}
    form{display:flex;flex-direction:column;gap:10px}
    input[type=text],input[type=password],input[type=email],textarea,select{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:inherit}
    button{background:var(--accent);border:none;padding:10px;border-radius:8px;font-weight:600;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} nav a{margin-left:8px}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .muted{color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .notice{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted);}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div>
      <a href="#/" class="logo">Brand Employment Agent</a>
      <span class="small muted"> — Demo</span>
    </div>
    <nav>
      <a href="#/">Home</a>
      <a href="#/apply">Application Form</a>
      <a href="#/login">Login</a>
      <a href="#/admin">Admin</a>
    </nav>
  </header>

  <main class="wrap">
    <div id="app"></div>
  </main>

<script>
/* CONFIG */
const API_BASE = (function(){
  // Default local dev
  return location.hostname === 'localhost' || location.hostname === '127.0.0.1' ? 'http://localhost:3000' : '';
})();
/* End config */

function $id(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c])); }

const routes = {'/': homeView, '/apply': applyView, '/login': loginView, '/admin': adminView};

function navigate(){
  const path = location.hash.replace('#','').split('?')[0] || '/';
  const view = routes[path] || notFound;
  document.getElementById('app').innerHTML = '';
  view();
}

/* --- Home --- */
function homeView(){
  const el = document.getElementById('app');
  el.innerHTML = `
    <div class="card grid">
      <div>
        <h1>Who we are</h1>
        <p class="lead">Brand Employment Agent connects families and employers with trained domestic workers. We focus on transparent recruitment, worker welfare and employer satisfaction.</p>
        <h2>Why choose Brand?</h2>
        <ul>
          <li>Experienced recruitment and placement services</li>
          <li>Pre-departure training and follow-up</li>
          <li>Support in destination country and local offices</li>
        </ul>

        <h2>Demo Access</h2>
        <div class="notice">
          <div class="small muted">Public demo credentials (for testing only)</div>
          <div><strong>Employer</strong>: employer@gmail.com / 123456</div>
          <div><strong>Jobseeker</strong>: jobseeker@gmail.com / 123456</div>
          <div><strong>Admin</strong>: admin@brandagent.com / admin123</div>
        </div>

        <p class="small">Example public site: https://pro.jobportalscriptphp.com/ (demo)</p>
      </div>

      <div>
        <h2>Quick actions</h2>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a class="btn-ghost" href="#/apply">Fill application form</a>
          <a class="btn-ghost" href="#/login">Login as user</a>
          <a class="btn-ghost" href="#/admin">Admin panel</a>
        </div>
        <div style="margin-top:12px" class="small muted">This is a front-end that uses an API for real storage.</div>
      </div>
    </div>
  `;
}

/* --- Application form --- */
function applyView(){
  const el = document.getElementById('app');
  el.innerHTML = `
    <div class="card">
      <h1>Domestic Labor Application Form</h1>
      <p class="small muted">Fill the form and click Submit. Data will be sent to the server.</p>
      <form id="appForm">
        <label>Full Name<input id="fullName" required /></label>
        <label>Sex
          <select id="sex"><option>Female</option><option>Male</option></select>
        </label>
        <label>Birth Date<input id="birthDate" type="date" required /></label>
        <label>Birth Place<input id="birthPlace" /></label>
        <label>Religion<input id="religion" /></label>
        <label>Age<input id="age" type="number" /></label>
        <label>Living Town<input id="livingTown" /></label>
        <label>Education Level<input id="education" /></label>
        <label>Marital Status<input id="marital" /></label>
        <label>No. of Children<input id="children" type="number" /></label>

        <h3>Language Skills</h3>
        <label>Arabic<select id="arabic"><option>Good</option><option>Poor</option></select></label>
        <label>English<select id="english"><option>Good</option><option>Poor</option></select></label>

        <h3>Domestic Work Skills</h3>
        <label><input type="checkbox" id="skill_ironing"/> Ironing</label>
        <label><input type="checkbox" id="skill_cleaning"/> Cleaning</label>
        <label><input type="checkbox" id="skill_babysit"/> Babysitting</label>

        <h3>Experience Abroad</h3>
        <div class="small muted">Add country, duration and role (comma separated per line)</div>
        <textarea id="experience" rows="4" placeholder="Dubai,2 yrs,Babysitting\nQatar,3 yrs,Cleaning"></textarea>

        <h3>Contact</h3>
        <label>Phone<input id="phone" type="text" /></label>
        <label>Email<input id="email" type="email" /></label>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">Submit Application</button>
          <button type="button" id="fillSample" class="btn-ghost">Fill with sample</button>
        </div>
      </form>
    </div>
  `;

  document.getElementById('fillSample').onclick = () => {
    // user wanted ability to fill their own — but we keep sample fill button available if they request.
    document.getElementById('fullName').value='ALEMITU KEBEDE GEBREGIORGIS';
    document.getElementById('sex').value='Female';
    document.getElementById('birthDate').value='2001-12-28';
    document.getElementById('birthPlace').value='Adigrat';
    document.getElementById('religion').value='Christian';
    document.getElementById('age').value='24';
    document.getElementById('livingTown').value='Mekele';
    document.getElementById('education').value='Elementary – Grade 8';
    document.getElementById('marital').value='Divorced';
    document.getElementById('children').value='2';
    document.getElementById('arabic').value='Good';
    document.getElementById('english').value='Poor';
    document.getElementById('skill_ironing').checked=true;
    document.getElementById('skill_cleaning').checked=true;
    document.getElementById('skill_babysit').checked=true;
    document.getElementById('experience').value='Dubai,2 yrs,Babysitting\nQatar,3 yrs,Cleaning\nSaudi,4 yrs,House maid';
    document.getElementById('phone').value='';
    document.getElementById('email').value='';
  };

  document.getElementById('appForm').onsubmit = async function(e){
    e.preventDefault();
    const payload = {
      fullName: document.getElementById('fullName').value,
      sex: document.getElementById('sex').value,
      birthDate: document.getElementById('birthDate').value,
      birthPlace: document.getElementById('birthPlace').value,
      religion: document.getElementById('religion').value,
      age: document.getElementById('age').value,
      livingTown: document.getElementById('livingTown').value,
      education: document.getElementById('education').value,
      marital: document.getElementById('marital').value,
      children: document.getElementById('children').value,
      languages: {arabic: document.getElementById('arabic').value, english: document.getElementById('english').value},
      skills: {
        ironing: document.getElementById('skill_ironing').checked,
        cleaning: document.getElementById('skill_cleaning').checked,
        babysitting: document.getElementById('skill_babysit').checked
      },
      experience: document.getElementById('experience').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value
    };

    try {
      const res = await fetch((API_BASE||'') + '/api/submit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Server error');
      alert('Application submitted. Reference ID: ' + data.id);
      location.hash = '#/';
    } catch(err){
      alert('Submit failed: ' + err.message);
    }
  };
}

/* --- Login & Register --- */
function loginView(){
  const el = document.getElementById('app');
  el.innerHTML = `
    <div class="card">
      <h1>Login</h1>
      <form id="loginForm">
        <label>Email<input id="l_email" type="email" required /></label>
        <label>Password<input id="l_pass" type="password" required /></label>
        <div style="display:flex;gap:8px">
          <button type="submit">Login</button>
          <button id="registerBtn" type="button" class="btn-ghost">Register new</button>
        </div>
      </form>
      <div style="margin-top:12px" class="small muted">Admin OTP: On admin login you'll be prompted for mobile and a demo OTP.</div>
    </div>
  `;
  document.getElementById('registerBtn').onclick = showRegister;
  document.getElementById('loginForm').onsubmit = async function(e){
    e.preventDefault();
    const email = document.getElementById('l_email').value.trim().toLowerCase();
    const password = document.getElementById('l_pass').value;
    try {
      const res = await fetch((API_BASE||'') + '/api/login', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Login failed');
      // store token and role
      localStorage.setItem('brand_token', data.token);
      localStorage.setItem('brand_role', data.role);
      alert('Logged in as ' + data.role);
      if(data.role === 'admin') location.hash = '#/admin';
      else location.hash = '#/';
    } catch(err){
      alert('Login failed: ' + err.message);
    }
  }
}

function showRegister(){
  const el = document.getElementById('app');
  el.innerHTML = `
    <div class="card">
      <h1>Create account</h1>
      <form id="regForm">
        <label>Email<input id="r_email" type="email" required /></label>
        <label>Password<input id="r_pass" type="password" required /></label>
        <label>Role<select id="r_role"><option value="jobseeker">Jobseeker</option><option value="employer">Employer</option></select></label>
        <div style="display:flex;gap:8px"><button type="submit">Create</button><button type="button" onclick="location.hash='#/login'" class="btn-ghost">Cancel</button></div>
      </form>
    </div>
  `;
  document.getElementById('regForm').onsubmit = async function(e){
    e.preventDefault();
    const email = document.getElementById('r_email').value.trim().toLowerCase();
    const password = document.getElementById('r_pass').value;
    const role = document.getElementById('r_role').value;
    try {
      const res = await fetch((API_BASE||'') + '/api/register', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password,role})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Register failed');
      alert('Account created. You can now login.');
      location.hash = '#/login';
    } catch(err){
      alert('Register failed: ' + err.message);
    }
  }
}

/* --- Admin view --- */
async function adminView(){
  const token = localStorage.getItem('brand_token');
  const role = localStorage.getItem('brand_role');
  const el = document.getElementById('app');

  if(!token || role !== 'admin'){
    // show admin login form
    el.innerHTML = `
      <div class="card">
        <h1>Admin login</h1>
        <p class="small muted">Enter admin credentials to view submissions</p>
        <form id="adminLogin">
          <label>Email<input id="a_email" type="email" required /></label>
          <label>Password<input id="a_pass" type="password" required /></label>
          <div style="display:flex;gap:8px;margin-top:8px"><button type="submit">Login</button></div>
        </form>
      </div>
    `;
    document.getElementById('adminLogin').onsubmit = async function(e){
      e.preventDefault();
      const email = document.getElementById('a_email').value.trim().toLowerCase();
      const password = document.getElementById('a_pass').value;
      try {
        const res = await fetch((API_BASE||'') + '/api/login', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Invalid admin');
        if(data.role !== 'admin') throw new Error('Account is not admin');
        localStorage.setItem('brand_token', data.token);
        localStorage.setItem('brand_role', data.role);
        location.hash = '#/admin';
      } catch(err){
        alert('Admin login failed: ' + err.message);
      }
    };
    return;
  }

  // fetch submissions
  try {
    const res = await fetch((API_BASE||'') + '/api/submissions', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Failed to load');
    el.innerHTML = `
      <div class="card">
        <h1>Admin Panel</h1>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">Signed in as <strong>admin</strong></div>
          <div><button id="logoutAdmin" class="btn-ghost">Logout</button></div>
        </div>

        <h2 style="margin-top:12px">Submitted Applications (${data.length})</h2>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Name</th><th>Sex</th><th>Birth Date</th><th>Phone</th><th>Email</th><th>Created</th></tr></thead>
            <tbody id="subRows"></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="exportJson">Export JSON</button>
        </div>

        <div id="details" style="margin-top:12px"></div>
      </div>
    `;

    const tbody = document.getElementById('subRows');
    data.forEach((row,i)=> {
      // submissions in backend are stored as data JSON
      let s = row.dataObj || row.data;
      if(typeof s === 'string') {
        try { s = JSON.parse(s); } catch(e){ s = {fullName: row.data}; }
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="#" data-i="${i}" class="viewLink">${escapeHtml(s.fullName||'--')}</a></td>
                      <td>${escapeHtml(s.sex||'')}</td>
                      <td>${escapeHtml(s.birthDate||'')}</td>
                      <td>${escapeHtml(s.phone||'')}</td>
                      <td>${escapeHtml(s.email||'')}</td>
                      <td>${new Date(row.createdAt).toLocaleString()}</td>`;
      tbody.appendChild(tr);

      // store original object for details
      row._parsed = s;
    });

    document.getElementById('logoutAdmin').onclick = ()=>{ localStorage.removeItem('brand_token'); localStorage.removeItem('brand_role'); location.hash='#/'; };
    document.getElementById('exportJson').onclick = ()=> {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'submissions.json'; a.click(); URL.revokeObjectURL(url);
    }

    document.querySelectorAll('.viewLink').forEach(a => a.onclick = function(ev){
      ev.preventDefault();
      const idx = +this.dataset.i;
      const row = data[idx];
      const container = document.getElementById('details');
      let parsed = row.dataObj;
      if(!parsed) {
        try { parsed = JSON.parse(row.data); } catch(e){ parsed = {raw: row.data}; }
      }
      container.innerHTML = `<div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:8px"><h3>Details for ${escapeHtml(parsed.fullName || '--')}</h3><pre>${escapeHtml(JSON.stringify(parsed, null, 2))}</pre></div>`;
    });

  } catch(err){
    alert('Failed to load submissions: ' + err.message);
    localStorage.removeItem('brand_token'); localStorage.removeItem('brand_role'); location.hash = '#/login';
  }
}

function notFound(){ document.getElementById('app').innerHTML = '<div class="card"><h1>Not found</h1></div>'; }

/* init */
window.addEventListener('hashchange', navigate);
if(!location.hash) location.hash = '#/';
navigate();
</script>
</body>
</html>
